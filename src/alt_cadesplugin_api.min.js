!function(t,e){"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?module.exports=e():t.AltCadesPlugin=e()}(this,function(){var t,e,n=function(t,e){return function(){return t.apply(e,arguments)}},r=[].slice;return e=null,t=function(){function t(t){return null==t&&(t={}),this.set=n(this.set,this),this.get=n(this.get,this),this.getParam=n(this.getParam,this),this.init=n(this.init,this),e?e:(t.timeout&&(this.timeout=t.timeout),this.cadesplugin.JSModuleVersion="2.0",this.cadesplugin.async_spawn=this.asyncSpawn,this.cadesplugin.set=function(t){return function(e){return t.pluginObject=e}}(this),window.cadesplugin=this.cadesplugin,void(e=this))}return t.prototype.checked=!1,t.prototype.cadesplugin={},t.prototype.pluginObject=null,t.prototype.timeout=2e4,t.prototype.isWebkit=function(){return navigator.userAgent.match(/chrome/i)||navigator.userAgent.match(/opera/i)}(),t.prototype.isIE=function(){return"Microsoft Internet Explorer"===navigator.appName||navigator.userAgent.match(/Trident\/./i)}(),t.prototype.CAPICOM_LOCAL_MACHINE_STORE=1,t.prototype.CAPICOM_CURRENT_USER_STORE=2,t.prototype.CADESCOM_LOCAL_MACHINE_STORE=1,t.prototype.CADESCOM_CURRENT_USER_STORE=2,t.prototype.CADESCOM_CONTAINER_STORE=100,t.prototype.CAPICOM_MY_STORE="My",t.prototype.CAPICOM_STORE_OPEN_MAXIMUM_ALLOWED=2,t.prototype.CAPICOM_CERTIFICATE_FIND_SUBJECT_NAME=1,t.prototype.CADESCOM_XML_SIGNATURE_TYPE_ENVELOPED=0,t.prototype.CADESCOM_XML_SIGNATURE_TYPE_ENVELOPING=1,t.prototype.CADESCOM_XML_SIGNATURE_TYPE_TEMPLATE=2,t.prototype.XmlDsigGost3410UrlObsolete="http://www.w3.org/2001/04/xmldsig-more#gostr34102001-gostr3411",t.prototype.XmlDsigGost3411UrlObsolete="http://www.w3.org/2001/04/xmldsig-more#gostr3411",t.prototype.XmlDsigGost3410Url="urn:ietf:params:xml:ns:cpxmlsec:algorithms:gostr34102001-gostr3411",t.prototype.XmlDsigGost3411Url="urn:ietf:params:xml:ns:cpxmlsec:algorithms:gostr3411",t.prototype.CADESCOM_CADES_DEFAULT=0,t.prototype.CADESCOM_CADES_BES=1,t.prototype.CADESCOM_CADES_T=5,t.prototype.CADESCOM_CADES_X_LONG_TYPE_1=93,t.prototype.CADESCOM_ENCODE_BASE64=0,t.prototype.CADESCOM_ENCODE_BINARY=1,t.prototype.CADESCOM_ENCODE_ANY=-1,t.prototype.CAPICOM_CERTIFICATE_INCLUDE_CHAIN_EXCEPT_ROOT=0,t.prototype.CAPICOM_CERTIFICATE_INCLUDE_WHOLE_CHAIN=1,t.prototype.CAPICOM_CERTIFICATE_INCLUDE_END_ENTITY_ONLY=2,t.prototype.CAPICOM_CERT_INFO_SUBJECT_SIMPLE_NAME=0,t.prototype.CAPICOM_CERT_INFO_ISSUER_SIMPLE_NAME=1,t.prototype.CAPICOM_CERTIFICATE_FIND_SHA1_HASH=0,t.prototype.CAPICOM_CERTIFICATE_FIND_SUBJECT_NAME=1,t.prototype.CAPICOM_CERTIFICATE_FIND_ISSUER_NAME=2,t.prototype.CAPICOM_CERTIFICATE_FIND_ROOT_NAME=3,t.prototype.CAPICOM_CERTIFICATE_FIND_TEMPLATE_NAME=4,t.prototype.CAPICOM_CERTIFICATE_FIND_EXTENSION=5,t.prototype.CAPICOM_CERTIFICATE_FIND_EXTENDED_PROPERTY=6,t.prototype.CAPICOM_CERTIFICATE_FIND_APPLICATION_POLICY=7,t.prototype.CAPICOM_CERTIFICATE_FIND_CERTIFICATE_POLICY=8,t.prototype.CAPICOM_CERTIFICATE_FIND_TIME_VALID=9,t.prototype.CAPICOM_CERTIFICATE_FIND_TIME_NOT_YET_VALID=10,t.prototype.CAPICOM_CERTIFICATE_FIND_TIME_EXPIRED=11,t.prototype.CAPICOM_CERTIFICATE_FIND_KEY_USAGE=12,t.prototype.CAPICOM_DIGITAL_SIGNATURE_KEY_USAGE=128,t.prototype.CAPICOM_PROPID_ENHKEY_USAGE=9,t.prototype.CAPICOM_OID_OTHER=0,t.prototype.CAPICOM_OID_KEY_USAGE_EXTENSION=10,t.prototype.CAPICOM_EKU_CLIENT_AUTH=2,t.prototype.CAPICOM_EKU_SMARTCARD_LOGON=5,t.prototype.CAPICOM_EKU_OTHER=0,t.prototype.CAPICOM_AUTHENTICATED_ATTRIBUTE_SIGNING_TIME=0,t.prototype.CADESCOM_AUTHENTICATED_ATTRIBUTE_DOCUMENT_NAME=1,t.prototype.CADESCOM_AUTHENTICATED_ATTRIBUTE_DOCUMENT_DESCRIPTION=2,t.prototype.CADESCOM_ATTRIBUTE_OTHER=-1,t.prototype.CADESCOM_STRING_TO_UCS2LE=0,t.prototype.CADESCOM_BASE64_TO_BINARY=1,t.prototype.CADESCOM_DISPLAY_DATA_NONE=0,t.prototype.CADESCOM_DISPLAY_DATA_CONTENT=1,t.prototype.CADESCOM_DISPLAY_DATA_ATTRIBUTE=2,t.prototype.CADESCOM_ENCRYPTION_ALGORITHM_RC2=0,t.prototype.CADESCOM_ENCRYPTION_ALGORITHM_RC4=1,t.prototype.CADESCOM_ENCRYPTION_ALGORITHM_DES=2,t.prototype.CADESCOM_ENCRYPTION_ALGORITHM_3DES=3,t.prototype.CADESCOM_ENCRYPTION_ALGORITHM_AES=4,t.prototype.CADESCOM_ENCRYPTION_ALGORITHM_GOST_28147_89=25,t.prototype.CADESCOM_HASH_ALGORITHM_SHA1=0,t.prototype.CADESCOM_HASH_ALGORITHM_MD2=1,t.prototype.CADESCOM_HASH_ALGORITHM_MD4=2,t.prototype.CADESCOM_HASH_ALGORITHM_MD5=3,t.prototype.CADESCOM_HASH_ALGORITHM_SHA_256=4,t.prototype.CADESCOM_HASH_ALGORITHM_SHA_384=5,t.prototype.CADESCOM_HASH_ALGORITHM_SHA_512=6,t.prototype.CADESCOM_HASH_ALGORITHM_CP_GOST_3411=100,t.prototype.CADESCOM_HASH_ALGORITHM_CP_GOST_3411_2012_256=101,t.prototype.CADESCOM_HASH_ALGORITHM_CP_GOST_3411_2012_512=102,t.prototype.LOG_LEVEL_DEBUG=4,t.prototype.LOG_LEVEL_INFO=2,t.prototype.LOG_LEVEL_ERROR=1,t.prototype.asyncSpawn=function(t){var e,n,r,o;return e=function(t,e){var i,u;try{u=n[t](e)}catch(C){return i=C,Promise.reject(i)}return u.done?u.value:Promise.resolve(u.value).then(r,o)},n=t(Array.prototype.slice.call(arguments,1)),r=e.bind(e,"next"),o=e.bind(e,"throw"),r()},t.prototype.init=function(){return this.checked?$.when():this.isWebkit?this.initWebkit():this.initNpapi()},t.prototype.initWebkit=function(){var t;return t=$.Deferred(),$.getScript("chrome-extension://iifchhfnnmpdbibifmljnfjhpififfog/nmcades_plugin_api.js").then(function(t){return function(){return window.postMessage("cadesplugin_echo_request","*")}}(this)).fail(function(e){return function(){return t.reject("plugin_not_installed")}}(this)),$(window).on("message",function(e){return function(e){var n;if("cadesplugin_loaded"===(null!=e&&null!=(n=e.originalEvent)?n.data:void 0))return setTimeout(function(){return cpcsp_chrome_nmcades.check_chrome_plugin(function(e){return function(){return e.checked=!0,t.resolve()}}(this),function(e){return function(n){return e.checked=!0,t.reject(n)}}(this))},0)}}(this)),setTimeout(function(e){return function(){if(!e.checked)return t.reject("timeout")}}(this),this.timeout),t},t.prototype.initNpapi=function(){var t;return t=$.Deferred(),$(window).on("load",function(e){return function(n){var r;return e.loadNpapiPlugin(),e.checked=!0,r=e.checkNpapiPlugin(),r===!0?t.resolve():t.reject(r)}}(this)),t},t.prototype.loadNpapiPlugin=function(){var t,e;if(e=$('<object id="cadesplugin_object" type="application/x-cades" style="visibility:hidden;"></object>'),$("body").append(e),this.pluginObject=e[0],this.isIE)return t=$('<object id="certEnrollClassFactory" classid="clsid:884e2049-217d-11da-b2a4-000e7bbb2b09" style="visibility:hidden;"></object>'),$("body").append(t)},t.prototype.checkNpapiPlugin=function(){var t,e,n;try{return this.createObject("CAdESCOM.About"),!0}catch(r){return t=r,e=navigator.mimeTypes["application/x-cades"],e?(n=e.enabledPlugin,n?"plugin_not_loaded_but_object_cannot_create":"error_on_plugin_load"):"plugin_unreachable"}},t.prototype.createObject=function(t){var e;if(this.isIE){if(t.match(/X509Enrollment/i))try{return $("certEnrollClassFactory")[0].CreateObject(t)}catch(n){throw e=n,"setup_https_for_x509enrollment"}return new ActiveXObject(t)}return this.pluginObject.CreateObject(t)},t.prototype.getParam=function(t,e){var n,r,o,i;if(n=$.Deferred(),this.isWebkit)o="string"==typeof t?this.pluginObject.CreateObjectAsync(t).then(function(t){return function(n){return e?t.extractParam(n,e):n}}(this)):this.extractParam(t,e),o.then(n.resolve,n.reject);else try{"string"==typeof t?(i=this.createObject(t),e&&(i=this.extractParam(i,e))):i=this.extractParam(t,e),n.resolve(i)}catch(u){r=u,n.reject(r.message)}return n},t.prototype.extractParam=function(t,e){if("object"!=typeof e)return t[e];switch(e.args.length){case 0:return t[e.method]();case 1:return t[e.method](e.args[0]);case 2:return t[e.method](e.args[0],e.args[1]);case 3:return t[e.method](e.args[0],e.args[1],e.args[2]);case 4:return t[e.method](e.args[0],e.args[1],e.args[2],e.args[3])}},t.prototype.get=function(){var t,e,n;return e=arguments[0],n=arguments[1],t=3<=arguments.length?r.call(arguments,2):[],this.getParam(e,n).then(function(e){return function(n){return t.length>0?(t.unshift(n),e.get.apply(e,t)):n}}(this))},t.prototype.set=function(t,e,n){var r,o,i;if(this.isWebkit)return i={method:"propset_"+e,args:[n]},this.get(t,i);r=$.Deferred();try{t[e]=n,r.resolve()}catch(u){o=u,r.reject(o.message)}return r},t.prototype.getVersion=function(){return $.when(this.get("CAdESCOM.About","PluginVersion","MajorVersion"),this.get("CAdESCOM.About","PluginVersion","MinorVersion"),this.get("CAdESCOM.About","PluginVersion","BuildVersion")).then(function(t,e,n){var r;return r={major:t,minor:e,build:n,full:t+"."+e+"."+n}})},t.prototype.getCSPVersion=function(){return $.when(this.get("CAdESCOM.About",{method:"CSPVersion",args:["",75]},"MajorVersion"),this.get("CAdESCOM.About",{method:"CSPVersion",args:["",75]},"MinorVersion"),this.get("CAdESCOM.About",{method:"CSPVersion",args:["",75]},"BuildVersion")).then(function(t,e,n){var r;return r={major:t,minor:e,build:n,full:t+"."+e+"."+n}})},t.prototype.getCertificates=function(){var t,e,n;return n=null,t=null,e=[],this.get("CAdESCOM.Store").then(function(t){return function(e){return n=e,t.get(n,{method:"Open",args:[]})}}(this)).then(function(t){return function(){return t.get(n,"Certificates")}}(this)).then(function(e){return function(n){return t=n,e.get(t,"Count")}}(this)).then(function(r){return function(o){var i,u;return o?(i=$.when(),$.each(function(){u=[];for(var t=1;1<=o?t<=o:t>=o;1<=o?t++:t--)u.push(t);return u}.apply(this),function(n,o){var u;return u=null,i=i.then(function(){return r.get(t,{method:"Item",args:[o]})}).then(function(t){return u=t,$.when(r.get(u,"SubjectName"),r.get(u,"IssuerName"),r.get(u,"ValidFromDate"),r.get(u,"ValidToDate"),r.get(u,{method:"PublicKey",args:[]},"Algorithm","FriendlyName"),r.get(u,{method:"HasPrivateKey",args:[]}),r.get(u,{method:"IsValid",args:[]},"Result"),r.get(u,"Thumbprint"))}).then(function(t,n,r,o,i,C,_,p){if(new Date<new Date(o)&&C&&_)return e.push({subject:t,issuer:n,validFrom:r,validTo:o,algorithm:i,hasPrivateKey:C,isValid:_,thumbprint:p,certificate:u})}).then(null,function(){return $.Deferred(function(){return this.reject("certificate_read_error")})})}),i):(n.Close(),$.Deferred(function(){return this.reject("certificates_not_found")}))}}(this)).then(function(t){return function(){return e.length?e:$.Deferred(function(){return this.reject("valid_certificates_not_found")})}}(this))},t.prototype.signData=function(t,e){var n,r;return r=null,n=null,this.get("CAdESCOM.CPSigner").then(function(t){return function(e){var n,o;if(r=e,t.isWebkit)return n=null,o=null,t.get("CAdESCOM.CPAttribute").then(function(e){return n=e,t.set(n,"Name",0)}).then(function(){return t.set(n,"Value",new Date)}).then(function(){return t.get(r,"AuthenticatedAttributes2",{method:"Add",args:[n]})}).then(function(){return t.get("CADESCOM.CPAttribute")}).then(function(e){return o=e,t.set(o,"Name",1)}).then(function(){return t.set(o,"Value","Document Name")}).then(function(){return t.get(r,"AuthenticatedAttributes2",{method:"Add",args:[o]})})}}(this)).then(function(t){return function(){return t.set(r,"Certificate",e)}}(this)).then(function(t){return function(){return t.get("CAdESCOM.CadesSignedData")}}(this)).then(function(e){return function(r){return n=r,e.set(n,"Content",t)}}(this)).then(function(t){return function(){return t.set(r,"Options",t.CAPICOM_CERTIFICATE_INCLUDE_WHOLE_CHAIN)}}(this)).then(function(t){return function(){return t.get(n,{method:"SignCades",args:[r,t.CADESCOM_CADES_BES]})}}(this)).then(function(t){return function(t){return t}}(this))},t.prototype.signDataBase64=function(t,e){var n,r;return r=null,n=null,this.get("CAdESCOM.CPSigner").then(function(t){return function(e){var n,o;if(r=e,t.isWebkit)return n=null,o=null,t.get("CAdESCOM.CPAttribute").then(function(e){return n=e,t.set(n,"Name",0)}).then(function(){return t.set(n,"Value",new Date)}).then(function(){return t.get(r,"AuthenticatedAttributes2",{method:"Add",args:[n]})}).then(function(){return t.get("CADESCOM.CPAttribute")}).then(function(e){return o=e,t.set(o,"Name",1)}).then(function(){return t.set(o,"Value","Document Name")}).then(function(){return t.get(r,"AuthenticatedAttributes2",{method:"Add",args:[o]})})}}(this)).then(function(t){return function(){return t.set(r,"Certificate",e)}}(this)).then(function(t){return function(){return t.get("CAdESCOM.CadesSignedData")}}(this)).then(function(e){return function(r){return n=r,n.ContentEncoding=e.CADESCOM_BASE64_TO_BINARY,e.set(n,"Content",Base64.encode(t))}}(this)).then(function(t){return function(){return t.set(r,"Options",t.CAPICOM_CERTIFICATE_INCLUDE_WHOLE_CHAIN)}}(this)).then(function(t){return function(){return t.get(n,{method:"SignCades",args:[r,t.CADESCOM_CADES_BES]})}}(this)).then(function(t){return function(t){return t}}(this))},t}()});